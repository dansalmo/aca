<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>The Art Crime Archive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    
    <!-- Le styles -->
    <link href="../static/css/bootstrap.css" rel="stylesheet">
    <link href="../static/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="../static/css/docs.css" rel="stylesheet">
    <link href="../static/css/art-crime-archive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../static/assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../static/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../static/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../static/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../static/assets/ico/apple-touch-icon-57-precomposed.png">

    <script type="text/javascript" async="" id="gauges-tracker" data-site-id="4f0dc9fef5a1f55508000013" src="//secure.gaug.es/track.js"></script><script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script><script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-146052-10']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    {{style|safe}}
  </head>
  <body data-spy="scroll" data-target=".bs-docs-sidebar" data-twttr-rendered="true">
    <!-- Fluid grid system
    ================================================== -->
        <div class="banner">
          <div class="user-access">{{greeting|safe}}</div>
          <div class="logo"><a href="/"><img alt="The Art Crime Archive" src="../static/img/AC5_small.png"></a></div>
        </div>
    <div class="navbar navbar-mod">
      <div class="navbar-inner">
        <div class="container">
     
          <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
     
          <!-- Everything you want hidden at 940px or less, place within here -->
          <div class="nav-collapse">
            <!-- .nav, .navbar-search, .navbar-form, etc -->
            <ul class="nav">
              <li {{the_archive|safe}}><a href="#">The Archive</a></li>
<!--               <li><a href="#">Fellows</a></li>
              <li><a href="#">Events</a></li> -->
              <li {{my_articles|safe}}><a href="/my-articles?author={{user}}">My Articles</a></li>
              <li {{publish_article|safe}}><a href="#create-article">Create Article</a></li>
              <li {{publish_article|safe}}><a href="#create-article2">Create Article</a></li>
              <li {{about|safe}}><a href="/about">About</a></li>
           </ul>
          </div>
     
        </div>
      </div>
    </div>
    <div class="row-fluid" id="the-archive">
      <div class="span9">
        <div class="center-stage">{{center_stage|safe}}
        </div>
      </div>
       <div class="span3">
        <div id="twitter"><a class="twitter-timeline" href="https://twitter.com/artcrimearchive" data-widget-id="265603842639527936">Tweets by @artcrimearchive</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        </div>
      </div>
   </div>
    <!-- ================================================== -->
    <!-- javascript placed at the end of the document so the pages load faster -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="../static/js/jquery.fitvids.js"></script>
		<script src='../static/js/jquery.autosize.js'></script>
		<script src='../static/js/jquery.hint.js'></script>
		<script src='../static/js/jquery.history.js'></script>
    <script src="../static/js/bootstrap.js"></script>
    <!-- Analytics
    ================================================== -->
    <script>
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4f0dc9fef5a1f55508000013');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    <!-- autosize and autobuttons for comment boxes -->
			$(function(){
				$('.comment-text').autosize({append: "\n"});
			});
      $(function(){ 
			  // Place hints in all comment-text input elements with empty title attributes
				$('.comment-text[title!=""]').hint();
			});
      $(document).ready(function () {
        <!-- Fits videos in fluid grid -->
        // Target your .container, .wrapper, .post, etc.
        $(".center-stage").fitVids({ customSelector: "object[src^='/']"});
			  // If signed in, append a publish comment button when comment text is clicked.
        $('.comment-text').focus(function() {
          var form = $(this).parent();
          if (!form.find('input').length) {
            if ($('#not-signed-in').length) {
              window.location = $('#not-signed-in').attr('href') + '%23' + $(this).attr('id');
            }
            else {
              $(form).append('<div><input class="publish" id="publish-it" type="submit" value="Publish Comment" /></div>');
            }
          }
        });
        $('.comment-text').blur(function() {
          var form = $(this).parent()
          if ($.trim($(this).val()) == "add your comment...") {
              // user did not add comment, remove the div with publish comment button
            $(form.find('div')).remove();
          }
        });
        // Ajax history
        // set inital state to accessed page
        var updateNav = function(state){
            // Make clicked menu active
        $('a[href="#'+state+'"]').parent().addClass('active').siblings('.active').removeClass('active');
          // unhide selected sections and hide all others
        };
        $.History.bind(function(state){
            // Update the current element to indicate which state we are now on
            console.log('Our current state is: ['+state+']');
        });
        $.History.bind('create-article', function(state){
          updateNav(state);
          $('#the-archive').addClass('hidden');
        });
        $.History.bind('create-article2', function(state){
          updateNav(state);
          $('#the-archive').addClass('hidden');
        });
        $.History.bind('', function(state){
          updateNav(state);
          $('#the-archive').removeClass('hidden');
          		$('#result').load('about #the-archive');

        });
        // edit comment
        $('body').on('mouseenter', '.comment', function(){
            var user = $('.signed-in').attr('nickname').split('@')[0];
            var comment_author = $(this).attr('author');
            if (user == comment_author){
              $(this).css( 'cursor', 'pointer' );
            }
        });
        // helps .on submit detect which button was pressed
        $('body').on('click', 'input[type=submit]', function(e) {
              console.log($(this));
              $(this.form).data('clicked', this.value);
        });
        $('body').on('click', '.comment', function(){
            // create and show comment-edit form if comment is by signed in user
            var user = $('.signed-in').attr('nickname').split('@')[0];
            var comment_author = $(this).attr('author');
              console.log('in .comment', $(this));
            if (user == comment_author){
              var $comment_edit = $('.comment-add-' + $(this).attr('article')).clone();
              $comment_edit.attr('class', 'comment-edit');
              $comment_edit.insertAfter($(this));
              $comment_edit.find('div').remove();
              previous_comment = $(this).find('span[class="comment-display"]').text();
              $comment_edit.find('.comment-text').val(previous_comment);
              $comment_edit.find('.comment-text').attr('title', previous_comment);
              $comment_edit.find('.comment-form').attr('comment-id', $(this).attr('comment-id'));
              $comment_edit.find('.comment-form').attr('name', 'comment-edit-form');
              $comment_edit.find('.comment-form').attr('class', 'comment-edit-form');
              $(this).attr('class', 'comment hidden');
              $(this).next().find('textarea').focus();
              $(this).next().find('textarea').click();
            }
        });
        $('body').on('click', '.comment-edit', function(){
            // user has clicked into edit commnet
              console.log('in .comment-edit', $(this).find('input[class="publish"]').length);
            if (!$(this).find('input[class="publish"]').length) {
                $(this).find('.comment-edit-form').append('<div><input class="publish" id="publish-it" name="update" type="submit" value="Update" style="display: inline;" /><input class="publish" name="update" id="delete-it" type="submit" value="Delete" style="display: inline;"/></div>');
             }
        });
        $('body').on('mouseleave', '.comment-edit', function(){
            if ($(this).find('textarea').attr('title') == $(this).find('textarea').val()) {
              $(this).prev().attr('class', 'comment');
              $(this).remove();
            }
        });
        $('body').on('submit', '.comment-form', function(e) {
          var article_id = $(this).attr('article');
          var $textarea = $(this).find('textarea');
          var text = $textarea.val();
          $.ajax ({
              url: "/ArchiveService.post_comment",
              type: "POST",
              data: JSON.stringify({"article_id": article_id, "comment_text": text}),
              dataType: "json",
              contentType: "application/json; charset=utf-8",
              success: function(data) {
                  // copy hidden comment row before modifying with new comment
                  var $clone = $('#comment-' + article_id).clone();
              console.log('clone= ', $clone);
                  $('#comment-table-' + article_id).append($clone);
                  // fill in and unhide new comment row
                  new_comment_id = 'comment-' + article_id + '-' + data.comment_id
              console.log('new_comment_id= ', new_comment_id);
                  $('#comment-' + article_id).attr('id', new_comment_id);
                  $('#' + new_comment_id).find('span[class="comment-display"]').text(text);
                  $('#' + new_comment_id).find('a[class="comment-user"]').attr(data.user_url);
                  $('#' + new_comment_id).find('a[class="comment-user"]').text(data.nickname.split('@')[0]);
                  $('#' + new_comment_id).attr('comment-id', data.comment_id);
                  $('#' + new_comment_id).attr('author', data.nickname.split('@')[0]);
                  $('#' + new_comment_id).attr('class', 'comment');
              }
          });
          // reset comment form
          $textarea.val('');
          $('.comment-text[title!=""]').hint();
           $($(this).find('div')).remove();
          return false;
        });
        $('body').on('submit', '.comment-edit-form', function(e) {
          var article_id = $(this).attr('article');
          var comment_id = $(this).attr('comment-id');
          var $textarea = $(this).find('textarea');
          var text = $textarea.val();
          console.log($(this).data('clicked'), $(this));
          if ($(this).data('clicked') == "Update") {
              console.log($(this).attr('value'));
              $.ajax ({
                  url: "/ArchiveService.edit_comment",
                  type: "POST",
                  data: JSON.stringify({"article_id": article_id, 
                                        "comment_text": text, 
                                        "comment_id": comment_id}),
                  dataType: "json",
                  contentType: "application/json; charset=utf-8",
                  success: function(data) {
                      // update and unhide edited comment
                      new_comment_id = 'comment-' + article_id + '-' + comment_id;
                      $('#' + new_comment_id).find('span[class="comment-display"]').text(text);
                      $('#' + new_comment_id).find('span[class="comment-relativetime"]').text('0 minutes ago');
                      $('#' + new_comment_id).attr('class', 'comment');
                      $('#' + new_comment_id).next().remove();
                  }
              });
          }
          if ($(this).data('clicked') == "Delete") {
              console.log('in delete');
              $.ajax ({
                  url: "/ArchiveService.delete_comment",
                  type: "POST",
                  data: JSON.stringify({"article_id": article_id, 
                                        "comment_text": '', 
                                        "comment_id": comment_id}),
                  dataType: "json",
                  contentType: "application/json; charset=utf-8",
                  success: function(data) {
                      // update and hide deleted comment row
                      deleted_comment_id = 'comment-' + article_id + '-' + comment_id;
                      $('#' + deleted_comment_id).attr('class', 'comment deleted');
                      $('#' + deleted_comment_id).next().remove();
                      
                  }
              });
          }
          return false;
        });
      });

		</script>
  </body>
</html>